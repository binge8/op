name: Toolchain

on:
  repository_dispatch:
    types: Toolchain
  workflow_dispatch:
  #schedule:
    #- cron: 00 16 * * *

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  REPO_BRANCH: master
  UPLOAD_RELEASE: true
  FILE_NAME: Toolchain
  TZ: Asia/Shanghai

jobs:
  Build:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        PLATFORM: [rockchip/armv8, x86/64]
    steps:
      - name: ç­¾å‡º
        uses: actions/checkout@main
      - name: ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /etc/apt/sources.list.d /usr/local/lib/android
          sudo -E apt-get -yqq purge $(curl -fsSL https://raw.githubusercontent.com/binge8/ybin/master/bin/del) || true
          sudo -E apt-get -qq update
          sudo -E apt-get -yqq install $(curl -fsSL https://raw.githubusercontent.com/binge8/ybin/master/bin/get-apt)
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
      - name: æ‹‰å–æºç 
        run: |
          df -hT $PWD
          git clone --depth 1 $REPO_URL -b $REPO_BRANCH openwrt
          git clone https://github.com/binge8/ybin.git
      - name: æ›´æ–°Feeds
        run: |
          cd openwrt
          echo "OPENWRTROOT=$PWD" >> $GITHUB_ENV
          ./scripts/feeds update -a 
          ./scripts/feeds install -a
          #è®¾ç½®ç¯å¢ƒå˜é‡
          useVersionInfo=$(git show -s --date=short --format="ç¼–è¯‘å‰çš„æœ€åä¸€æ¬¡[â¦ä¸»æºç ](https://github.com/coolsnowwolf/lede)æ›´æ–°è®°å½•:<br/>æ›´æ–°äºº: %an<br/>æ›´æ–°æ—¶é—´: %cd<br/>æ›´æ–°å†…å®¹: %s<br/>å“ˆå¸Œå€¼: %H")
          echo "useVersionInfo=$useVersionInfo" >> $GITHUB_ENV
          echo "DATE=$(date "+%Yå¹´%mæœˆ%dæ—¥%Hæ—¶")" >> $GITHUB_ENV
          echo "DATE1=$(date "+%Y.%m.%d")" >> $GITHUB_ENV
      - name: ä¸‹è½½Packages
        env:
          PLATFORM: ${{ matrix.PLATFORM }}
        run: |
          mv ybin/config/$PLATFORM.config $OPENWRTROOT/.config
          cd $OPENWRTROOT
          make defconfig
          make download -j16
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
      - name: ç¼–è¯‘Tools
        run: |
          cd $OPENWRTROOT
          echo -e "$(nproc) thread compile"
          make tools/compile -j$(($(nproc) + 1)) || make tools/compile -j1 V=s
      - name: ç¼–è¯‘Toolchain
        run: |
          cd $OPENWRTROOT
          echo -e "$(nproc) thread compile"
          make toolchain/compile -j$(($(nproc) + 1)) || make toolchain/compile -j1 V=s
          make diffconfig
          cd $OPENWRTROOT/bin/targets/*
          TARGET=$(basename `pwd`)
          echo "TARGET=$TARGET" >> $GITHUB_ENV
          cd *
          rm *
          SUBTARGET=$(basename `pwd`)
          echo "SUBTARGET=$SUBTARGET" >> $GITHUB_ENV
      - name: æ¸…ç†æ–‡ä»¶
        run: |
          cd $OPENWRTROOT
          make clean
          rm -rf tmp logs .config* dl
          ./scripts/feeds clean
      - name: æ‰“åŒ…
        run: |
          export FILE_NAME="toolchain-$TARGET-$SUBTARGET"
          mkdir output && tar -zcf output/$FILE_NAME.tar.gz openwrt
          cd output && split -b 1900M -d -a 1 $FILE_NAME.tar.gz $FILE_NAME.tar.gz.
          df -hT $PWD
      - name: å‘å¸ƒrelease
        if: env.UPLOAD_RELEASE == 'true'
        uses: ncipollo/release-action@main
        with:
          name: ${{ env.DATE }} ğŸš€ Toolchain | è‡ªåŠ¨ç¼–è¯‘
          omitNameDuringUpdate: true
          omitBodyDuringUpdate: true
          allowUpdates: true
          tag: 1Toolchain
          commit: master
          token: ${{ secrets.RELEASES_TOKEN }}
          body: |
            ${{ env.useVersionInfo }}
          artifacts: output/*
  over:
    runs-on: ubuntu-20.04
    needs: [Build]
    steps:
      - name: Checkout
        uses: actions/checkout@main
      - name: å¾®ä¿¡æ¨é€
        run: curl -H "Content-Type:application/json" -X POST -d '{"token":"${{ secrets.pushbot }}","title":"${{ env.FILE_NAME }}æˆåŠŸ","content":"${{ env.FILE_NAME }}å‘å¸ƒæˆåŠŸ","template":"json"}' http://www.pushplus.plus/send
