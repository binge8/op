name: Update-Check

on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  repository_dispatch:
    types: Update-Check
  #schedule:
    #- cron: '0 0 * * *' # æ¯å¤© UTC æ—¶é—´ 00:00 è‡ªåŠ¨è¿è¡Œ

jobs:
  Update-Check:
    runs-on: ubuntu-24.04
    steps:
      - name: è·å–Hash
        id: getHash
        run: |
          # åˆ›å»ºä¸´æ—¶ç›®å½•
          TMP_DIR=$(mktemp -d) || { echo "âœ— é”™è¯¯: åˆ›å»ºä¸´æ—¶ç›®å½•å¤±è´¥"; exit 1; }
          trap 'rm -rf "$TMP_DIR"' EXIT
          
          # è·å–ä»“åº“åˆ—è¡¨
          mapfile -t REPOS <<< "$(curl https://ac.cxw28.cn/REPO_LIST)"
          
          # å­˜å‚¨æ‰€æœ‰commit IDçš„æ•°ç»„
          COMMIT_IDS=()
          
          # å¤„ç†æ¯ä¸ªä»“åº“
          for entry in "${REPOS[@]}"; do
            # åˆ†å‰²ç”¨æˆ·å/ä»“åº“åå’Œåˆ†æ”¯
            IFS=':' read -r REPO_PATH BRANCH <<< "$entry"
            
            # éªŒè¯è¾“å…¥æ ¼å¼
            if [[ -z "$REPO_PATH" || -z "$BRANCH" ]]; then
              echo "âœ— é”™è¯¯: æ— æ•ˆçš„ä»“åº“æ ¼å¼ '$entry'ï¼Œåº”ä¸º user/repo:branch" >&2
              continue
            fi
          
            # ç›´æ¥ä½¿ç”¨ä»“åº“è·¯å¾„æ„å»ºURLï¼ˆå…³é”®ä¿®æ­£ï¼‰
            REPO_URL="https://github.com/${REPO_PATH}.git"
            # åˆ›å»ºå®‰å…¨çš„ä¸´æ—¶ç›®å½•åç§°ï¼ˆæ›¿æ¢/ä¸º-ï¼‰
            SAFE_REPO_NAME=$(echo "$REPO_PATH" | tr '/' '-')
          
            echo "æ­£åœ¨å¤„ç†: $REPO_PATH ($BRANCH åˆ†æ”¯)"
            echo "å…‹éš†URL: $REPO_URL"
          
            # æµ…å…‹éš†ä»“åº“
            git clone --quiet --depth 1 --branch "$BRANCH" "$REPO_URL" "$TMP_DIR/$SAFE_REPO_NAME" 2>/dev/null
          
            if [ $? -eq 0 ]; then
              # è·å–ç®€çŸ­Commit ID (7å­—ç¬¦)
              COMMIT_ID=$(git -C "$TMP_DIR/$SAFE_REPO_NAME" rev-parse --short=4 HEAD 2>/dev/null)
              if [ -n "$COMMIT_ID" ]; then
                COMMIT_IDS+=("$COMMIT_ID")
                echo "âœ“ æˆåŠŸè·å–: $COMMIT_ID"
              else
                echo "âœ— é”™è¯¯: æ— æ³•è·å– $REPO_PATH çš„ Commit ID" >&2
              fi
            else
              echo "âœ— é”™è¯¯: $REPO_PATH åˆ†æ”¯ $BRANCH è·å–å¤±è´¥" >&2
            fi
          done
          
          # å†™å…¥æ–‡ä»¶
          echo "commitHash=$(IFS='+'; echo "${COMMIT_IDS[*]}")" >> $GITHUB_OUTPUT

      - name: æ¯”è¾ƒHash
        id: cacheHash
        uses: actions/cache@main
        with:
          path: .commitHash
          key: HEAD-${{ steps.getHash.outputs.commitHash }}

      - name: æ›´æ–°Hash
        if: ${{ always() }}
        run: |
          if [ "${{steps.cacheHash.outputs.cache-hit}}" = "true" ];then
            echo "STATUS=âœ… æºç æ— æ›´æ–° | æš‚åœç¼“å­˜" >> $GITHUB_ENV
          else
            if [ -n "${{ steps.getHash.outputs.commitHash }}" ];then
              echo "STATUS=âœ… æºç æœ‰æ›´æ–° | å¼€å§‹ç¼“å­˜" >> $GITHUB_ENV
              curl -X POST https://api.github.com/repos/binge8/op/dispatches -H "Accept: application/vnd.github.everest-preview+json" -H "Authorization: token ${{ secrets.RELEASES_TOKEN }}" --data '{"event_type": "Toolchain"}'
              echo ${{ steps.getHash.outputs.commitHash }} | tee .commitHash
            else
              echo "STATUS=âŒ æºç æ›´æ–°æ£€æµ‹å¤±è´¥" >> $GITHUB_ENV
            fi
          fi

      - name: åˆ é™¤è¿è¡Œè®°å½•
        if: ${{ always() }}
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ secrets.RELEASES_TOKEN }}
          repository: ${{ github.repository }}
          retain_days: 5
          keep_minimum_runs: 3
      - name: ä¼ä¸šå¾®ä¿¡åº”ç”¨æ¶ˆæ¯æ¨é€
        if: ${{ always() }}
        env:
          CORP_ID: ${{ secrets.CORP_ID }}
          CORP_SECRET: ${{ secrets.CORP_SECRET }}
          AGENT_ID: ${{ secrets.AGENT_ID }}
          TEXT:  |
            ğŸš€GitHub Action é€šçŸ¥
            
            ä»“åº“: ${{ github.repository }}
            -----------------------------
            ${{ env.STATUS }}
          PROXY_URL: ${{ secrets.PROXY_URL }}  # ä»£ç†ï¼ˆå¯é€‰ï¼‰
        run: |
          wget --no-check-certificate https://ac.cxw28.cn/notify.py && chmod +x notify.py
          python3 notify.py